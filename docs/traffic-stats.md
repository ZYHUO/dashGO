# æµé‡ç»Ÿè®¡åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

XBoard æä¾›äº†å®Œæ•´çš„æµé‡ç»Ÿè®¡åŠŸèƒ½ï¼Œç”¨äºç›‘æ§å’Œåˆ†æç³»ç»Ÿçš„æµé‡ä½¿ç”¨æƒ…å†µã€‚

## æ•°æ®åº“è¡¨ç»“æ„

### 1. v2_stat_user - ç”¨æˆ·æµé‡ç»Ÿè®¡è¡¨

è®°å½•æ¯ä¸ªç”¨æˆ·çš„æµé‡ä½¿ç”¨æƒ…å†µã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | bigint | ç”¨æˆ·ID |
| server_rate | decimal(10,2) | æœåŠ¡å™¨å€ç‡ |
| u | bigint | ä¸Šä¼ æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| d | bigint | ä¸‹è½½æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| record_type | varchar(2) | è®°å½•ç±»å‹ï¼ˆd=æ—¥ï¼Œm=æœˆï¼‰ |
| record_at | bigint | è®°å½•æ—¶é—´æˆ³ |
| created_at | bigint | åˆ›å»ºæ—¶é—´ |
| updated_at | bigint | æ›´æ–°æ—¶é—´ |

### 2. v2_stat_server - èŠ‚ç‚¹æµé‡ç»Ÿè®¡è¡¨

è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„æµé‡ä½¿ç”¨æƒ…å†µã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| server_id | bigint | èŠ‚ç‚¹ID |
| server_type | varchar(11) | èŠ‚ç‚¹ç±»å‹ |
| u | bigint | ä¸Šä¼ æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| d | bigint | ä¸‹è½½æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| record_type | varchar(1) | è®°å½•ç±»å‹ï¼ˆd=æ—¥ï¼Œm=æœˆï¼‰ |
| record_at | bigint | è®°å½•æ—¶é—´æˆ³ |
| created_at | bigint | åˆ›å»ºæ—¶é—´ |
| updated_at | bigint | æ›´æ–°æ—¶é—´ |

### 3. v2_stat - å…¨å±€ç»Ÿè®¡è¡¨

è®°å½•ç³»ç»Ÿçš„å…¨å±€ç»Ÿè®¡æ•°æ®ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| record_at | bigint | è®°å½•æ—¶é—´æˆ³ï¼ˆå”¯ä¸€ï¼‰ |
| record_type | varchar(1) | è®°å½•ç±»å‹ï¼ˆd=æ—¥ï¼Œm=æœˆï¼‰ |
| order_count | int | è®¢å•æ•°é‡ |
| order_total | bigint | è®¢å•æ€»é¢ |
| commission_count | int | ä½£é‡‘è®¢å•æ•° |
| commission_total | bigint | ä½£é‡‘æ€»é¢ |
| paid_count | int | å·²æ”¯ä»˜è®¢å•æ•° |
| paid_total | bigint | å·²æ”¯ä»˜æ€»é¢ |
| register_count | int | æ³¨å†Œç”¨æˆ·æ•° |
| invite_count | int | é‚€è¯·ç”¨æˆ·æ•° |
| transfer_used_total | varchar(32) | æ€»æµé‡ä½¿ç”¨ |
| created_at | bigint | åˆ›å»ºæ—¶é—´ |
| updated_at | bigint | æ›´æ–°æ—¶é—´ |

### 4. v2_server_log - èŠ‚ç‚¹æµé‡æ—¥å¿—è¡¨

è®°å½•è¯¦ç»†çš„æµé‡æ—¥å¿—ã€‚

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | bigint | ç”¨æˆ·ID |
| server_id | bigint | èŠ‚ç‚¹ID |
| u | bigint | ä¸Šä¼ æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| d | bigint | ä¸‹è½½æµé‡ï¼ˆå­—èŠ‚ï¼‰ |
| rate | decimal(10,2) | å€ç‡ |
| method | varchar(32) | åè®®æ–¹æ³• |
| created_at | bigint | åˆ›å»ºæ—¶é—´ |
| updated_at | bigint | æ›´æ–°æ—¶é—´ |

## API æ¥å£

### æµé‡ç»Ÿè®¡æ¥å£

#### 1. æµé‡æ¦‚è§ˆ

```
GET /api/v2/admin/traffic/overview
```

è¿”å›æ•°æ®ï¼š
```json
{
  "total_upload": 1073741824,
  "total_download": 5368709120,
  "total_traffic": 6442450944,
  "active_users": 10,
  "top_users": [
    {
      "user_id": 1,
      "email": "user@example.com",
      "upload": 536870912,
      "download": 2684354560,
      "total": 3221225472
    }
  ],
  "upload_percent": 16.67,
  "download_percent": 83.33
}
```

#### 2. èŠ‚ç‚¹æµé‡ç»Ÿè®¡

```
GET /api/v2/admin/traffic/servers
```

è¿”å›æ•°æ®ï¼š
```json
[
  {
    "server_id": 1,
    "server_name": "é¦™æ¸¯èŠ‚ç‚¹",
    "server_type": "shadowsocks",
    "upload": 536870912,
    "download": 2684354560,
    "total": 3221225472
  }
]
```

#### 3. æ¯æ—¥æµé‡ç»Ÿè®¡

```
GET /api/v2/admin/traffic/daily?days=30
```

è¿”å›æœ€è¿‘ N å¤©çš„æµé‡ç»Ÿè®¡æ•°æ®ã€‚

#### 4. ç”¨æˆ·æµé‡è¯¦æƒ…

```
GET /api/v2/admin/traffic/user/:id
```

è¿”å›æŒ‡å®šç”¨æˆ·çš„è¯¦ç»†æµé‡ä¿¡æ¯ã€‚

### æµé‡ç®¡ç†æ¥å£

#### 5. è·å–æµé‡ç»Ÿè®¡

```
GET /api/v2/admin/traffic/stats
```

è¿”å›æµé‡ç»Ÿè®¡æ¦‚è§ˆï¼ŒåŒ…æ‹¬æ€»æµé‡ã€æ´»è·ƒç”¨æˆ·æ•°ã€è¶…æµé‡ç”¨æˆ·æ•°ç­‰ã€‚

#### 6. è·å–æµé‡é¢„è­¦ç”¨æˆ·

```
GET /api/v2/admin/traffic/warnings?threshold=80
```

å‚æ•°ï¼š
- `threshold`: æµé‡ä½¿ç”¨é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œé»˜è®¤ 80

è¿”å›æµé‡ä½¿ç”¨è¶…è¿‡é˜ˆå€¼çš„ç”¨æˆ·åˆ—è¡¨ã€‚

#### 7. é‡ç½®ç”¨æˆ·æµé‡

```
POST /api/v2/admin/traffic/reset/:id
```

é‡ç½®æŒ‡å®šç”¨æˆ·çš„æµé‡ï¼ˆå°† u å’Œ d è®¾ç½®ä¸º 0ï¼‰ã€‚

#### 8. æ‰¹é‡é‡ç½®æµé‡

```
POST /api/v2/admin/traffic/reset-all
```

é‡ç½®æ‰€æœ‰éœ€è¦é‡ç½®æµé‡çš„ç”¨æˆ·ã€‚

#### 9. å‘é€æµé‡é¢„è­¦é€šçŸ¥

```
POST /api/v2/admin/traffic/warning/:id
```

å‘æŒ‡å®šç”¨æˆ·å‘é€æµé‡é¢„è­¦é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰ã€‚

#### 10. æ‰¹é‡å‘é€æµé‡é¢„è­¦

```
POST /api/v2/admin/traffic/warnings/send?threshold=80
```

å‘æ‰€æœ‰æµé‡ä½¿ç”¨è¶…è¿‡é˜ˆå€¼çš„ç”¨æˆ·æ‰¹é‡å‘é€é¢„è­¦é€šçŸ¥ã€‚

#### 11. è‡ªåŠ¨å°ç¦è¶…æµé‡ç”¨æˆ·

```
POST /api/v2/admin/traffic/autoban
```

è‡ªåŠ¨å°ç¦æ‰€æœ‰æµé‡è¶…é™çš„ç”¨æˆ·ã€‚

### Agent æ¥å£

#### 12. ä¸ŠæŠ¥æµé‡

```
POST /api/v1/agent/traffic
```

Agent ä¸ŠæŠ¥æµé‡æ•°æ®ã€‚

è¯·æ±‚ä½“ï¼š
```json
{
  "nodes": [
    {
      "id": 1,
      "users": [
        {
          "username": "user-uuid",
          "upload": 1024000,
          "download": 2048000
        }
      ]
    }
  ]
}
```

## å‰ç«¯é¡µé¢

### æµé‡ç»Ÿè®¡é¡µé¢

è·¯å¾„ï¼š`/admin/traffic`

åŠŸèƒ½ï¼š
- ğŸ“Š æ€»æµé‡ã€ä¸Šä¼ ã€ä¸‹è½½ç»Ÿè®¡å¡ç‰‡
- ğŸ“ˆ ä¸Šä¼ /ä¸‹è½½å æ¯”é¥¼å›¾
- ğŸ“Š èŠ‚ç‚¹æµé‡å æ¯”å›¾è¡¨
- ğŸ“‹ ç”¨æˆ·æµé‡æ’è¡Œæ¦œ

### æµé‡ç®¡ç†é¡µé¢

è·¯å¾„ï¼š`/admin/traffic-management`

åŠŸèƒ½ï¼š
- ğŸ“Š æµé‡ç»Ÿè®¡æ¦‚è§ˆ
- âš ï¸ æµé‡é¢„è­¦ç”¨æˆ·åˆ—è¡¨
- ğŸ”„ æ‰¹é‡é‡ç½®æµé‡
- ğŸ“§ æ‰¹é‡å‘é€é¢„è­¦é€šçŸ¥
- ğŸš« è‡ªåŠ¨å°ç¦è¶…æµé‡ç”¨æˆ·

## æµé‡è®°å½•æœºåˆ¶

### 1. å®æ—¶è®°å½•

å½“ Agent ä¸ŠæŠ¥æµé‡æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. æ›´æ–°ç”¨æˆ·çš„ `u`ï¼ˆä¸Šä¼ ï¼‰å’Œ `d`ï¼ˆä¸‹è½½ï¼‰å­—æ®µ
2. è®°å½•åˆ° `v2_server_log` è¡¨ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
3. æ›´æ–° `v2_stat_user` ç»Ÿè®¡è¡¨ï¼ˆç”¨æˆ·ç»´åº¦ï¼‰
4. æ›´æ–° `v2_stat_server` ç»Ÿè®¡è¡¨ï¼ˆèŠ‚ç‚¹ç»´åº¦ï¼‰

**å®ç°ç»†èŠ‚**ï¼š
- Agent æ¯åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡æµé‡å¢é‡
- ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·çº§æµé‡ç»Ÿè®¡ï¼ˆé€šè¿‡ Clash APIï¼‰
- å¤‡ç”¨æ–¹æ¡ˆï¼šç«¯å£æµé‡å¹³å‡åˆ†é…
- æ‰€æœ‰æµé‡æ•°æ®éƒ½åº”ç”¨èŠ‚ç‚¹å€ç‡

### 2. ç»Ÿè®¡å‘¨æœŸ

- **å®æ—¶ç»Ÿè®¡**ï¼šAgent æ¯åˆ†é’Ÿä¸ŠæŠ¥ï¼Œç«‹å³æ›´æ–°æ•°æ®åº“
- **æ—¥ç»Ÿè®¡ï¼ˆdï¼‰**ï¼šæ¯å¤© 00:00 è‡ªåŠ¨ç”Ÿæˆå‰ä¸€å¤©çš„ç»Ÿè®¡æ•°æ®
- **æœˆç»Ÿè®¡ï¼ˆmï¼‰**ï¼šæ¯æœˆ 1 æ—¥ 00:00 è‡ªåŠ¨ç”Ÿæˆä¸Šæœˆçš„ç»Ÿè®¡æ•°æ®

### 3. å€ç‡è®¡ç®—

æµé‡ä¼šæ ¹æ®èŠ‚ç‚¹çš„å€ç‡ï¼ˆrateï¼‰è¿›è¡Œè®¡ç®—ï¼š

```
å®é™…æ‰£é™¤æµé‡ = (ä¸Šä¼  + ä¸‹è½½) Ã— å€ç‡
```

ä¾‹å¦‚ï¼š
- èŠ‚ç‚¹å€ç‡ä¸º 1.0ï¼šä½¿ç”¨ 1GB æ‰£é™¤ 1GB
- èŠ‚ç‚¹å€ç‡ä¸º 0.5ï¼šä½¿ç”¨ 1GB æ‰£é™¤ 0.5GB
- èŠ‚ç‚¹å€ç‡ä¸º 2.0ï¼šä½¿ç”¨ 1GB æ‰£é™¤ 2GB

### 4. æ•°æ®æ¸…ç†

ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼š
- **æµé‡æ—¥å¿—**ï¼šä¿ç•™ 90 å¤©ï¼Œæ¯å‘¨ä¸€è‡ªåŠ¨æ¸…ç†
- **æ—¥ç»Ÿè®¡**ï¼šä¿ç•™ 1 å¹´ï¼Œæ¯å‘¨ä¸€è‡ªåŠ¨æ¸…ç†
- **æœˆç»Ÿè®¡**ï¼šæ°¸ä¹…ä¿ç•™

## æ³¨æ„äº‹é¡¹

### âš ï¸ æµé‡ç»Ÿè®¡ç²¾åº¦

å½“å‰å®ç°ä½¿ç”¨**å¹³å‡åˆ†é…ç®—æ³•**ï¼Œå•ç”¨æˆ·æµé‡ç»Ÿè®¡å¯èƒ½ä¸å¤Ÿç²¾ç¡®ã€‚è¿™æ˜¯å› ä¸ºï¼š

1. **å¤šç”¨æˆ·å…±äº«èŠ‚ç‚¹**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæµé‡æ˜¯å¹³å‡åˆ†é…çš„
2. **æ— ç²¾ç¡®æµæ§**ï¼šç³»ç»Ÿä¸æ”¯æŒç²¾ç¡®çš„å•ç”¨æˆ·æµé‡æ§åˆ¶
3. **ç»Ÿè®¡å»¶è¿Ÿ**ï¼šæµé‡æ•°æ®ç”± Agent å®šæœŸä¸ŠæŠ¥ï¼Œå­˜åœ¨ä¸€å®šå»¶è¿Ÿ

### é€‚ç”¨åœºæ™¯

- âœ… ç›‘æ§æ€»ä½“æµé‡è¶‹åŠ¿
- âœ… è¯†åˆ«é«˜æµé‡ç”¨æˆ·
- âœ… èŠ‚ç‚¹æµé‡åˆ†æ
- âœ… æµé‡é¢„è­¦å’Œç®¡ç†
- âŒ ç²¾ç¡®çš„å•ç”¨æˆ·è®¡è´¹ï¼ˆéœ€è¦ä¸“ä¸šæµæ§æ–¹æ¡ˆï¼‰

### æ”¹è¿›å»ºè®®

å¦‚éœ€ç²¾ç¡®çš„å•ç”¨æˆ·æµé‡ç»Ÿè®¡ï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨ä¸“ä¸šæµæ§æ–¹æ¡ˆ**
   - åœ¨èŠ‚ç‚¹ä¸Šå®ç°çœŸæ­£çš„å¤šç”¨æˆ·æµæ§
   - ä½¿ç”¨ iptables/nftables è¿›è¡Œç²¾ç¡®ç»Ÿè®¡

2. **ç‹¬ç«‹èŠ‚ç‚¹éƒ¨ç½²**
   - ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ç‹¬ç«‹çš„èŠ‚ç‚¹ç«¯å£
   - é€šè¿‡ç«¯å£çº§åˆ«ç»Ÿè®¡æµé‡

3. **ä½¿ç”¨ç¬¬ä¸‰æ–¹æµæ§æ’ä»¶**
   - é›†æˆä¸“ä¸šçš„æµé‡ç»Ÿè®¡æ’ä»¶
   - å®ç°æ›´ç²¾ç¡®çš„æµé‡è®°å½•

## éƒ¨ç½²å’Œé…ç½®

### 1. æ•°æ®åº“è¿ç§»

åˆ›å»ºæµé‡ç»Ÿè®¡è¡¨ï¼š

```bash
# æ‰§è¡Œè¿ç§»
./migrate-linux-amd64 -config configs/config.yaml

# æˆ–ä½¿ç”¨ Docker
docker exec xboard ./migrate -config /app/configs/config.yaml
```

è¿ç§»æ–‡ä»¶ä½ç½®ï¼š
- `migrations/005_create_traffic_stats_tables.sql`
- `migrations/005_create_traffic_stats_tables_rollback.sql`

### 2. Agent é…ç½®

Agent ä¼šè‡ªåŠ¨ä¸ŠæŠ¥æµé‡æ•°æ®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚ç¡®ä¿ï¼š

1. Agent æ­£å¸¸è¿è¡Œå¹¶è¿æ¥åˆ°é¢æ¿
2. sing-box é…ç½®ä¸­å¯ç”¨äº† Clash API
3. Agent æ¯åˆ†é’Ÿè‡ªåŠ¨ä¸ŠæŠ¥æµé‡

### 3. å®šæ—¶ä»»åŠ¡

ç³»ç»Ÿä¼šè‡ªåŠ¨è¿è¡Œä»¥ä¸‹å®šæ—¶ä»»åŠ¡ï¼š

- **æ¯åˆ†é’Ÿ**ï¼šAgent ä¸ŠæŠ¥æµé‡
- **æ¯å°æ—¶**ï¼šå‘é€æµé‡é¢„è­¦é€šçŸ¥
- **æ¯å¤©å‡Œæ™¨**ï¼šç”Ÿæˆæ—¥ç»Ÿè®¡ã€å‘é€åˆ°æœŸæé†’
- **æ¯æœˆ 1 å·**ï¼šé‡ç½®æœˆæµé‡ã€ç”Ÿæˆæœˆç»Ÿè®¡
- **æ¯å‘¨ä¸€**ï¼šæ¸…ç†æ—§æ•°æ®

### 4. é‚®ä»¶é…ç½®

å¦‚éœ€ä½¿ç”¨æµé‡é¢„è­¦é€šçŸ¥åŠŸèƒ½ï¼Œè¯·é…ç½®é‚®ä»¶æœåŠ¡ï¼š

```yaml
mail:
  host: smtp.example.com
  port: 587
  username: your-email@example.com
  password: your-password
  from: noreply@example.com
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

å·²åˆ›å»ºçš„ç´¢å¼•ï¼š
- `user_id` - ç”¨æˆ·æŸ¥è¯¢
- `server_id` - èŠ‚ç‚¹æŸ¥è¯¢
- `record_at` - æ—¶é—´èŒƒå›´æŸ¥è¯¢
- `created_at` - æ—¥å¿—æŸ¥è¯¢

### 2. æ•°æ®æ¸…ç†

å»ºè®®å®šæœŸæ¸…ç†æ—§çš„æµé‡æ—¥å¿—ï¼š

```sql
-- åˆ é™¤ 90 å¤©å‰çš„æµé‡æ—¥å¿—
DELETE FROM v2_server_log WHERE created_at < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 90 DAY));

-- åˆ é™¤ 1 å¹´å‰çš„æ—¥ç»Ÿè®¡
DELETE FROM v2_stat_user WHERE record_type = 'd' AND record_at < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 YEAR));
DELETE FROM v2_stat_server WHERE record_type = 'd' AND record_at < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 YEAR));
```

### 3. åˆ†è¡¨ç­–ç•¥

å¯¹äºå¤§æµé‡ç³»ç»Ÿï¼Œå»ºè®®ï¼š
- æŒ‰æœˆåˆ†è¡¨å­˜å‚¨æµé‡æ—¥å¿—
- ä½¿ç”¨æ—¶é—´åºåˆ—æ•°æ®åº“ï¼ˆå¦‚ InfluxDBï¼‰å­˜å‚¨æµé‡æ•°æ®
- å®šæœŸå½’æ¡£å†å²æ•°æ®

## æ•…éšœæ’æŸ¥

### æµé‡ç»Ÿè®¡ä¸å‡†ç¡®

1. æ£€æŸ¥ Agent æ˜¯å¦æ­£å¸¸ä¸ŠæŠ¥
2. æ£€æŸ¥èŠ‚ç‚¹å€ç‡é…ç½®
3. æŸ¥çœ‹ `v2_server_log` è¡¨æ˜¯å¦æœ‰è®°å½•
4. æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

### æµé‡æ•°æ®ä¸¢å¤±

1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
3. ç¡®è®¤ Agent å¿ƒè·³æ­£å¸¸
4. æ£€æŸ¥æ•°æ®åº“ç£ç›˜ç©ºé—´

### æ€§èƒ½é—®é¢˜

1. æ£€æŸ¥æ•°æ®åº“ç´¢å¼•
2. ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
3. å¢åŠ æ•°æ®åº“è¿æ¥æ± 
4. è€ƒè™‘ä½¿ç”¨ç¼“å­˜ï¼ˆRedisï¼‰

## ç›¸å…³æ–‡æ¡£

- [Agent è‡ªåŠ¨æ›´æ–°](agent-auto-update.md)
- [ä¸»æœºç®¡ç†](../README.md#ä¸»æœºç®¡ç†)
- [èŠ‚ç‚¹ç®¡ç†](../README.md#èŠ‚ç‚¹ç®¡ç†)
