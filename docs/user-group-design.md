# 用户组设计说明

## 设计理念

用户组（UserGroup）的职责应该**清晰且单一**：

### ✅ 用户组应该做什么

1. **权限控制** - 决定用户可以访问哪些节点
   - `server_ids`: 该组可访问的节点ID列表
   
2. **套餐可见性** - 决定用户可以购买哪些套餐
   - `plan_ids`: 该组可购买的套餐ID列表

### ❌ 用户组不应该做什么

用户组**不应该**设置流量、速度、设备限制等配额，这些应该由**套餐（Plan）**来决定。

**原因：**
- 流量、速度、设备限制是**商品属性**，应该属于套餐
- 用户购买不同的套餐，获得不同的配额
- 用户组只是**权限分组**，不是**配额分组**

## 数据流程

### 正确的流程

```
用户注册
  ↓
分配到用户组（如：试用用户组）
  ↓
用户组决定：
  - 可以看到哪些节点
  - 可以购买哪些套餐
  ↓
用户购买套餐
  ↓
套餐决定：
  - 获得多少流量
  - 速度限制是多少
  - 可以连接几个设备
  ↓
（可选）套餐购买后升级用户组
  - 升级到更高级的用户组
  - 解锁更多节点和套餐
```

### 错误的流程（已废弃）

```
❌ 用户组设置默认流量
❌ 用户继承用户组的流量配额
```

这种设计会导致：
- 逻辑混乱：流量既在用户组又在套餐
- 难以管理：修改流量需要同时修改两个地方
- 不符合商业逻辑：用户应该为套餐付费，而不是为用户组付费

## 实际案例

### 案例1：试用用户

```yaml
用户组: 试用用户
  server_ids: [1, 2]        # 只能访问基础节点
  plan_ids: [1, 2, 3]       # 可以购买入门套餐

套餐1: 月付基础版
  transfer_enable: 50GB     # 流量在套餐中定义
  speed_limit: 100Mbps
  upgrade_group_id: 2       # 购买后升级到"普通用户"组
```

### 案例2：VIP用户

```yaml
用户组: VIP用户
  server_ids: [1, 2, 3, 4, 5, 6]  # 可以访问所有节点
  plan_ids: [10, 11, 12]          # 可以购买高级套餐

套餐10: VIP月付
  transfer_enable: 500GB    # 流量在套餐中定义
  speed_limit: null         # 无限速
  upgrade_group_id: null    # 已经是最高组，不需要升级
```

## 迁移说明

### 已废弃的字段

以下字段已标记为废弃，但为了向后兼容仍然保留在数据库中：

- `default_transfer_enable` - 默认流量（废弃）
- `default_speed_limit` - 默认速度限制（废弃）
- `default_device_limit` - 默认设备限制（废弃）

### API 变更

**创建/更新用户组时，不再接受以下参数：**
- `default_transfer_enable`
- `default_speed_limit`
- `default_device_limit`

**只需要提供：**
```json
{
  "name": "VIP用户",
  "description": "高级用户组",
  "server_ids": [1, 2, 3, 4, 5],
  "plan_ids": [10, 11, 12],
  "sort": 3
}
```

### 前端变更

如果前端有用户组管理界面，需要：
1. 移除"默认流量"、"默认速度"、"默认设备数"等输入框
2. 在界面上说明：流量等配额由套餐决定
3. 强调用户组的作用是权限控制

## 常见问题

### Q: 如果我想给试用用户1GB流量怎么办？

A: 创建一个"试用套餐"，设置流量为1GB，然后在试用用户组的 `plan_ids` 中包含这个套餐。

### Q: 如果我想让所有VIP用户都有500GB流量？

A: 创建VIP套餐，设置流量为500GB。用户购买VIP套餐后，自动升级到VIP用户组。

### Q: 用户组的默认流量字段还在数据库里，会不会影响系统？

A: 不会。这些字段已经不再被代码使用，保留它们只是为了向后兼容。你可以选择删除它们，也可以保留。

### Q: 我能不能给用户组设置一个"最低流量保障"？

A: 不建议。这会让逻辑变复杂。正确的做法是：
- 为每个用户组创建对应的套餐
- 在套餐中设置流量
- 用户购买套餐获得流量

## 总结

**记住这个原则：**
- 用户组 = 权限分组（能看到什么、能买什么）
- 套餐 = 商品（买了能得到什么）

这样设计清晰、易于理解、便于管理。
